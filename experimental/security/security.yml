# yaml-language-server: $schema=https://schema.infrahub.app/infrahub/schema/latest.json
---
version: "1.0"
generics:
  - name: GenericIdentity
    namespace: Security
    include_in_menu: false
    display_labels:
      - name__value
    attributes:
      - name: name
        kind: Text
        label: Name
        optional: false
        unique: true
  - name: GenericAddressGroup
    namespace: Security
    include_in_menu: false
    hierarchical: true
    attributes:
      - name: description
        label: Description
        kind: Text
        optional: true
    relationships:
      - name: addresses
        peer: SecurityGenericAddress
        cardinality: many
        kind: Component
        optional: true
  - name: GenericAddress
    namespace: Security
    include_in_menu: false
    relationships:
      - name: address_groups
        label: Address Groups
        peer: SecurityGenericAddressGroup
        cardinality: many
        optional: true
  - name: GenericServiceGroup
    namespace: Security
    include_in_menu: false
    hierarchical: true
    attributes:
      - name: description
        label: Description
        kind: Text
        optional: true
    relationships:
      - name: services
        peer: SecurityGenericService
        label: Services
        cardinality: many
        kind: Component
        optional: true
  - name: GenericService
    include_in_menu: false
    namespace: Security
    attributes:
      - name: description
        kind: Text
        label: Description
        optional: true
    relationships:
      - name: service_groups
        label: Service Groups
        peer: SecurityGenericServiceGroup
        cardinality: many
        optional: true
  - name: GenericPerson
    namespace: Security
    attributes:
      - name: email_address
        kind: Email
nodes:
##
  - name: Employee
    namespace: Organization
    include_in_menu: true
    inherit_from:
      - SecurityGenericPerson
      - SecurityGenericIdentity
    relationships:
      - name: organization
        peer: OrganizationGeneric
        cardinality: one
        optional: true
  - name: EmployeeGroup
    namespace: Organization
    include_in_menu: true
    inherit_from:
      - SecurityGenericIdentity
    relationships:
      - name: employees
        peer: OrganizationEmployee
        cardinality: many
        optional: true
      - name: groups
        peer: OrganizationEmployeeGroup
        cardinality: many
        optional: true
  - name: DeviceTag
    namespace: Security
    include_in_menu: true
    inherit_from:
      - SecurityGenericIdentity
  - name: TailscaleAutogroup
    namespace: Security
    include_in_menu: true
    inherit_from:
      - SecurityGenericIdentity
##
  - name: IPAddress
    namespace: Security
    menu_placement: SecurityPolicy
    include_in_menu: true
    description: "IPv4/6 address"
    human_friendly_id:
      - name__value
    label: "IP Address"
    icon: "mdi:ip-outline"
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericAddress
    order_by:
      - "address__value"
    display_labels:
      - name__value
      - address__value
    attributes:
      - name: address
        kind: IPHost
      - name: description
        kind: Text
        optional: true
  - name: Prefix
    namespace: Security
    menu_placement: SecurityPolicy
    include_in_menu: true
    icon: "mdi:ip-network-outline"
    description: "IPv4/6 prefix"
    label: "Prefix"
    human_friendly_id:
      - name__value
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericAddress
    order_by:
      - name__value
    display_labels:
      - name__value
      - prefix__value
    attributes:
      - name: prefix
        kind: IPNetwork
        optional: false
        unique: true
      - name: description
        kind: Text
        optional: true
  - name: IPRange
    namespace: Security
    menu_placement: SecurityPolicy
    include_in_menu: true
    icon: "mdi:ip-outline"
    description: "IPv4/6 Range"
    label: "IP Range"
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericAddress
    order_by:
      - name__value
    attributes:
      - name: start
        label: Start IP Address
        kind: IPHost
        optional: false
      - name: end
        label: End IP Address
        kind: IPHost
        optional: false
  - name: FQDN
    namespace: Security
    description: "Full Qualified Domain Name"
    include_in_menu: true
    icon: "eos-icons:dns"
    menu_placement: SecurityPolicy
    label: "FQDN"
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericAddress
    order_by:
      - name__value
      - fqdn__value
    attributes:
      - name: fqdn
        label: FQDN
        kind: Text
        optional: false
        # https://stackoverflow.com/questions/11809631/fully-qualified-domain-name-validation
        regex: "(?=^.{1,253}$)(^(((?!-)[a-zA-Z0-9-]{1,63}(?<!-))|((?!-)[a-zA-Z0-9-]{1,63}(?<!-)\\.)+[a-zA-Z]{2,63})$)"
  - name: AddressGroup
    namespace: Security
    menu_placement: SecurityPolicy
    include_in_menu: true
    icon: "material-symbols:menu-book-outline-rounded"
    description: "Group of addresses"
    label: Address Group
    human_friendly_id:
      - name__value
    parent: SecurityAddressGroup
    display_labels:
      - name__value
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericAddressGroup

  - name: IPProtocol
    namespace: Security
    menu_placement: SecurityPolicy
    icon: "mdi:protocol"
    include_in_menu: true
    description: "IP protocol"
    label: IP Protocols
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
    order_by:
      - name__value
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericService
    attributes:
      - name: protocol
        kind: Number
        optional: true

  - name: Service
    namespace: Security
    menu_placement: SecurityPolicy
    include_in_menu: true
    icon: "eos-icons:application-outlined"
    description: "Service"
    label: Service
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
    order_by:
      - name__value
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericService
    attributes:
      - name: port
        kind: Number
    relationships:
      - name: ip_protocol
        peer: SecurityIPProtocol
        optional: true
        cardinality: one
        kind: Attribute

  - name: ServiceRange
    namespace: Security
    menu_placement: SecurityPolicy
    include_in_menu: true
    icon: "eos-icons:application-outlined"
    description: "Service range"
    label: Service range
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
    order_by:
      - name__value
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericService
    attributes:
      - name: start
        kind: Number
        optional: false
      - name: end
        kind: Number
        optional: false
    relationships:
      - name: ip_protocol
        peer: SecurityIPProtocol
        optional: false
        cardinality: one
        kind: Attribute

  - name: ServiceGroup
    namespace: Security
    menu_placement: SecurityPolicy
    include_in_menu: true
    icon: "material-symbols:menu-book-outline-rounded"
    label: Service group
    description: "Group of services"
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
    order_by:
      - name__value
    inherit_from:
      - SecurityGenericIdentity
      - SecurityGenericServiceGroup
  - name: Policy
    namespace: Security
    label: "Security Policy"
    human_friendly_id:
      - name__value
    display_labels:
      - name__value
    order_by:
      - name__value
    attributes:
      - name: name
        label: Name
        kind: Text
        optional: false
      - name: description
        label: Description
        kind: Text
        optional: true
    relationships:
      - name: rules
        peer: SecurityPolicyRule
        cardinality: many
        kind: Component
      - name: location_target
        peer: LocationGeneric
        cardinality: one
        optional: true
        kind: Attribute
  - name: PolicyRule
    namespace: Security
    menu_placement: SecurityPolicy
    include_in_menu: true
    icon: "material-symbols:policy"
    label: Policy rule
    description: "Policy rule"
    order_by:
      - policy__name__value
      - index__value
    uniqueness_constraints:
      - [index__value, policy]
    attributes:
      - name: index
        label: Index
        kind: Number
        optional: false
        order_weight: 99999
      - name: name
        label: Name
        kind: Text
        optional: false
      - name: action
        label: Action
        kind: Text
        enum: ["permit", "deny"]
        default_value: permit
        optional: false
      - name: log
        label: Log
        kind: Boolean
        default_value: false
        optional: true
        order_weight: 99998
    relationships:
      - name: policy
        peer: SecurityPolicy
        kind: Attribute
        cardinality: one
        optional: false
      - name: source
        peer: SecurityGenericIdentity
        optional: true
        kind: Attribute
        cardinality: many
        identifier: policy_rule__source
      - name: destination
        peer: SecurityGenericIdentity
        optional: true
        kind: Attribute
        cardinality: many
        identifier: policy_rule__destination
extensions:
  nodes:
    - kind: LocationGeneric
      relationships:
        - name: policy
          peer: SecurityPolicy
          cardinality: one
          kind: Attribute
